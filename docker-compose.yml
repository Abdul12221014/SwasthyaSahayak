# Docker Compose for SwasthyaSahayak Development Environment

version: '3.8'

services:
  # PostgreSQL with pgvector extension
  postgres:
    image: ankane/pgvector:latest
    container_name: swasthya-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-swasthya}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-swasthya_db}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./src/backend/db/migrations:/docker-entrypoint-initdb.d
    networks:
      - swasthya-network

  # ML Inference Service
  ml-service:
    build:
      context: .
      dockerfile: Dockerfile.ml
    container_name: swasthya-ml
    environment:
      - EMBEDDING_MODEL_PATH=/models/embeddings/model_v1
      - EMERGENCY_CLASSIFIER_PATH=/models/emergency/model_v1
      - TRANSLATION_MODEL_PATH=/models/translation/model_v1
      - ML_SERVICE_PORT=8000
    ports:
      - "8000:8000"
    volumes:
      - ./src/ml:/app/src/ml
      - ml_models:/models
    networks:
      - swasthya-network
    depends_on:
      - postgres
    command: uvicorn src.ml.inference.service:app --host 0.0.0.0 --port 8000 --reload

  # Frontend (Vite Dev Server)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: swasthya-frontend
    environment:
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_PUBLISHABLE_KEY=${VITE_SUPABASE_PUBLISHABLE_KEY}
    ports:
      - "8080:8080"
    volumes:
      - ./src/frontend:/app/src/frontend
      - ./src/shared:/app/src/shared
      - ./index.html:/app/index.html
      - node_modules:/app/node_modules
    networks:
      - swasthya-network
    command: npm run dev

  # pgAdmin (optional - for database management)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: swasthya-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@swasthya.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    networks:
      - swasthya-network
    depends_on:
      - postgres
    profiles:
      - admin

volumes:
  postgres_data:
  ml_models:
  node_modules:

networks:
  swasthya-network:
    driver: bridge

